<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­¦ä¿ ç­ç´šç¶“ç‡Ÿ - å®—é–€å•Ÿç¤ºéŒ„ (V7.4 è¬å¯¶éˆç¸ç‰ˆ)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@600;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap');
        
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: rgba(30, 25, 20, 0.95);
            --border-color: #8c6f4f;
            --text-gold: #ffd700;
            --text-beige: #f0e0c0;
            --text-brown: #d0b090;
            --rank-1: #ffd700;
            --rank-2: #c0c0c0;
            --rank-3: #cd7f32;
        }

        body {
            margin: 0; padding: 0; width: 100%; min-height: 100vh;
            font-family: 'Noto Serif TC', 'SimSun', serif;
            background-color: var(--bg-color);
            background-image: url('https://html-classic.itch.zone/html/16280602/%E6%AD%A6%E4%BF%A0%E7%AD%94%E9%A1%8C%E5%82%B3/images/title_background_inkwash.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-beige);
            overflow-x: hidden;
            user-select: none;
        }

        .pixel-border {
            border: 3px solid var(--border-color);
            box-shadow: 0 0 0 2px #201000, inset 0 0 0 1px #e0c0a0, 0 5px 15px rgba(0,0,0,0.6);
            border-radius: 4px;
            position: relative;
        }

        .pixel-btn {
            background-color: #b88a5a;
            border: 2px solid #503010;
            color: #fff8e1;
            padding: 8px 16px;
            font-size: 1rem;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 4px 0 #403020;
            transition: all 0.1s;
            text-shadow: 1px 1px 1px #302010;
            position: relative;
            image-rendering: pixelated;
            white-space: nowrap;
            border-radius: 4px;
        }
        .pixel-btn:hover { background-color: #c89a6a; transform: translateY(-2px); box-shadow: 0 6px 0 #403020; }
        .pixel-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #403020; }
        .pixel-btn.primary { background: linear-gradient(to bottom, #d44848, #9f2626); border-color: #581212; }
        .pixel-btn.success { background: linear-gradient(to bottom, #48d46d, #269f43); border-color: #125824; }
        .pixel-btn.info { background: linear-gradient(to bottom, #3a7bd5, #00d2ff); border-color: #005f73; }
        .pixel-btn.gold { background: linear-gradient(to bottom, #ffd700, #ff8c00); border-color: #8b4500; color: #3e1f00; }
        .pixel-btn:disabled { filter: grayscale(1); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }

        #app-container { max-width: 1200px; margin: 0 auto; padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        header { text-align: center; padding: 15px; background: var(--panel-bg); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; position: relative; flex-wrap: wrap; gap: 10px; }
        h1 { margin: 0; font-size: 2rem; color: var(--text-gold); text-shadow: 2px 2px 0 #000, 0 0 10px rgba(255, 215, 0, 0.5); letter-spacing: 2px; }
        .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .teacher-only { display: none !important; }
        input[type="text"], input[type="password"], input[type="number"] { background: rgba(0,0,0,0.3); border: 2px solid var(--border-color); color: var(--text-beige); padding: 8px; font-family: inherit; outline: none; }
        input:focus { border-color: var(--text-gold); background: rgba(0,0,0,0.5); }
        .gender-radio { display: flex; gap: 10px; align-items: center; color: var(--text-brown); }
        .gender-radio label { cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .gender-radio input[type="radio"] { accent-color: #b88a5a; width: 16px; height: 16px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; overflow-y: auto; padding-right: 10px; padding-bottom: 50px; }

        /* å¡ç‰‡èˆ‡å…‰æ•ˆ */
        .student-card { background-color: rgba(40, 30, 20, 0.9); padding: 15px; display: flex; flex-direction: column; gap: 8px; position: relative; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .student-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 15px 30px rgba(0,0,0,0.6); z-index: 10; border-color: var(--text-gold); }
        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border-color); padding-bottom: 5px; margin-bottom: 5px; }
        .student-name { font-size: 1.5rem; color: var(--text-gold); font-weight: bold; text-shadow: 1px 1px 2px #000; display:flex; align-items:center; gap:5px;}
        .title-badge { padding: 2px 6px; border: 1px solid #ffd700; color: #ffd700; background: rgba(255,215,0,0.1); border-radius: 6px; font-size: 0.75rem; text-shadow: 0 0 6px rgba(255,215,0,0.4); }
        .level-badge { font-family: 'Black Ops One', cursive, sans-serif; font-size: 1.8rem; color: #00d2ff; text-shadow: 0 0 5px #005f73, 2px 2px 0 #000; background: rgba(0,0,0,0.5); padding: 0 8px; border-radius: 4px; border: 1px solid #005f73; }
        .avatar-area { display: flex; justify-content: center; align-items: flex-end; margin: 5px 0; height: 200px; overflow: hidden; position: relative; background: radial-gradient(circle at bottom, rgba(255,255,255,0.12) 0%, rgba(0,0,0,0) 70%); border-radius: 4px; border: 1px solid rgba(112, 80, 48, 0.5); }
        .avatar-img { height: 95%; width: auto; object-fit: contain; image-rendering: pixelated; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); transition: filter 0.3s; z-index: 2; animation: breathe 3s infinite ease-in-out; }
        @keyframes breathe { 0%, 100% { filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)) brightness(1); } 50% { filter: drop-shadow(0 0 16px rgba(255,215,0,0.55)) brightness(1.12); } }

        /* æ”¾å¤§æ­¦å™¨èˆ‡å¯µç‰© */
        .companion-img { position: absolute; width: auto; object-fit: contain; image-rendering: pixelated; z-index: 3; filter: drop-shadow(0 0 8px rgba(0,0,0,0.8)); }
        .companion-pet { height: 100px; bottom: 0px; left: -12px; animation: float 3s ease-in-out infinite; }
        .companion-sword { height: 130px; top: -5px; right: -18px; transform: rotate(-18deg); animation: floatSword 4s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        @keyframes floatSword { 0%, 100% { transform: translateY(0) rotate(-18deg); } 50% { transform: translateY(-10px) rotate(-24deg); } }

        .stat-row { display: flex; align-items: center; font-size: 0.9rem; gap: 5px; margin-bottom: 3px; }
        .stat-label { width: 45px; color: var(--text-brown); text-align: right; }
        .bar-container { flex-grow: 1; height: 16px; background: #2a2015; border: 1px solid #503010; border-radius: 8px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; transition: width 0.5s ease; }
        .bar-exp { background: linear-gradient(to right, #4facfe, #00f2fe); box-shadow: 0 0 10px #00f2fe; }
        .stat-value { font-size: 0.8rem; color: #fff; margin-left: 5px; min-width: 80px; text-align: right; font-family: monospace;}
        .coin-display { color: #ffd700; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .card-actions, .common-actions { display: grid; gap: 5px; margin-top: 5px; }
        .card-actions { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
        .common-actions { grid-template-columns: 1fr; }
        .action-btn-small { padding: 4px; font-size: 0.8rem; }
        .card-edit-btn { position: absolute; top: 5px; right: 5px; background: none; border: none; color: #d0b090; cursor: pointer; font-size: 1.2rem; opacity: 0.6; z-index: 5; }
        .card-edit-btn:hover { opacity: 1; color: #fff; }

        /* æ’è¡Œæ¦œ */
        .leaderboard-row { display: flex; align-items: center; padding: 10px; background: rgba(0,0,0,0.3); border-bottom: 1px solid #503010; transition: background 0.2s; }
        .leaderboard-row:hover { background: rgba(255,255,255,0.05); }
        .rank-num { width: 40px; font-weight: bold; font-size: 1.2rem; text-align: center; }
        .rank-1 .rank-num { color: var(--rank-1); text-shadow: 0 0 10px var(--rank-1); font-size: 1.5rem; }
        .rank-2 .rank-num { color: var(--rank-2); text-shadow: 0 0 8px var(--rank-2); font-size: 1.4rem; }
        .rank-3 .rank-num { color: var(--rank-3); text-shadow: 0 0 5px var(--rank-3); font-size: 1.3rem; }
        .lb-name { flex-grow: 1; color: var(--text-beige); font-size: 1.1rem; }
        .lb-cp { width: 100px; text-align: right; color: #00f2fe; font-family: 'Black Ops One'; }
        .lb-avatar { width: 40px; height: 40px; object-fit: cover; border-radius: 50%; border: 2px solid #503010; margin-right: 10px; background: #000;}

        /* è¡Œå›Šèˆ‡å•†åº— */
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; max-height: 320px; overflow-y: auto; padding: 10px; }
        .inventory-item { width: 60px; height: 60px; background: rgba(0,0,0,0.35); border: 1px solid var(--border-color); border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .inventory-item:hover { background: rgba(255,255,255,0.08); border-color: var(--text-gold); }
        .inventory-item img { width: 52px; height: 52px; image-rendering: pixelated; }
        .inventory-item.equipped { border: 2px solid #48d46d; box-shadow: 0 0 7px #48d46d; }
        .item-tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.95); color: #fff; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); font-size: 0.85rem; white-space: pre-line; display: none; z-index: 20; pointer-events: none; min-width: 160px; text-align: left; }
        .inventory-item:hover .item-tooltip { display: block; }
        .cp-bonus { color: #00f2fe; font-weight: bold; }
        .item-price { color: #ffd700; font-size: 0.9rem; margin-top: 5px;}

        /* è¬å¯¶é–£ Tabs */
        .shop-tabs { display:flex; gap:10px; margin-bottom:10px; justify-content:center; flex-wrap:wrap; }
        .shop-tab { padding:8px 14px; border:1px solid #503010; border-radius:8px; background:rgba(0,0,0,0.35); color:var(--text-beige); cursor:pointer; }
        .shop-tab.active { border-color: var(--text-gold); color: var(--text-gold); box-shadow: 0 0 10px rgba(255,215,0,0.3); }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; padding: 6px; max-height: 420px; overflow-y: auto; }
        .shop-card { background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(0,0,0,0.45)); border: 1px solid var(--border-color); padding: 12px; display: flex; flex-direction: column; align-items: center; gap: 6px; text-align: center; }
        .shop-card.pet { box-shadow: 0 0 12px rgba(0, 200, 255, 0.25); }
        .shop-card.reward { box-shadow: 0 0 12px rgba(255, 120, 80, 0.25); }
        .shop-card img { width: 72px; height: 72px; image-rendering: pixelated; }
        .shop-card h4 { margin: 5px 0; color: var(--text-gold); }
        .shop-card p { font-size: 0.85rem; color: #cfc2a6; margin: 0; min-height: 32px;}

        /* Modals */
        #battle-modal, #system-modal, #inventory-modal, #edit-student-modal, #batch-modal, #loading-overlay, #leaderboard-modal, #shop-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }
        #system-modal, #edit-student-modal, #batch-modal, #leaderboard-modal, #shop-modal { z-index: 2000; }
        #loading-overlay { z-index: 9999; background: #1a1a1a; display: flex; }
        #battle-stage { width: 820px; height: 520px; background-size: cover; position: relative; border: 4px solid #302010; box-shadow: 0 0 50px rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: space-between; padding: 20px; transition: background-image 0.5s ease; }
        .battle-top { display: flex; justify-content: space-between; align-items: flex-end; height: 60%; padding: 0 50px; }
        .fighter { display: flex; flex-direction: column; align-items: center; position: relative; }
        .fighter img { height: 190px; image-rendering: pixelated; filter: drop-shadow(0 0 10px rgba(255,255,255,0.25)); transition: transform 0.2s; opacity: 1; }
        .fighter img.treasure-chest { height: 130px; margin-bottom: 30px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .fighter-name { background: rgba(0,0,0,0.7); color: var(--text-gold); padding: 2px 8px; border-radius: 4px; margin-bottom: 5px; border: 1px solid var(--border-color); }
        #battle-ui { background: rgba(40,30,20,0.95); border: 2px solid var(--border-color); padding: 15px; text-align: center; height: 30%; display: flex; flex-direction: column; justify-content: center; gap: 15px; }
        #battle-msg { font-size: 1.5rem; color: var(--text-beige); margin: 0; }
        .battle-controls { display: flex; justify-content: center; gap: 20px; }

        @keyframes shake { 0% { transform: translate(0, 0); } 25% { transform: translate(-5px, 0); } 75% { transform: translate(5px, 0); } 100% { transform: translate(0, 0); } }
        .shake-effect { animation: shake 0.3s ease-in-out; }
        @keyframes levelUpFloat { 0% { transform: translateY(0) scale(0.5); opacity: 0; } 50% { transform: translateY(-20px) scale(1.2); opacity: 1; } 100% { transform: translateY(-50px) scale(1); opacity: 0; } }
        .float-text { position: absolute; color: gold; font-weight: bold; font-size: 1.6rem; text-shadow: 0 0 6px #000; pointer-events: none; animation: levelUpFloat 1.5s forwards; z-index: 100; }
        .flash-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; }
        @keyframes flash { 0% { opacity: 0.8; } 100% { opacity: 0; } }
        .hit-spark { position:absolute; width:140px; height:80px; mix-blend-mode:screen; pointer-events:none; animation: hitSpark 0.45s ease-out; opacity:0.9; }
        @keyframes hitSpark { 0% { transform: translate(-50%,-50%) scale(0.6) rotate(0deg); opacity:0.95;} 100% { transform: translate(-50%,-50%) scale(1.4) rotate(20deg); opacity:0; } }
        @keyframes damageFlash { 0% { filter: drop-shadow(0 0 12px rgba(255,255,255,0.6)) brightness(1.6);} 100% { filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)) brightness(1);} }
        .damage-flash { animation: damageFlash 0.35s ease-out; }
        .aura-low .avatar-img  { filter: drop-shadow(0 0 8px rgba(0,180,255,0.35)) brightness(1.05); }
        .aura-mid .avatar-img  { filter: drop-shadow(0 0 12px rgba(255,215,0,0.55)) brightness(1.1); }
        .aura-high .avatar-img { filter: drop-shadow(0 0 16px rgba(255,120,200,0.65)) brightness(1.15); }
        #level-up-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; z-index: 9999; background: rgba(255, 215, 0, 0.1); justify-content: center; align-items: center; }
        #level-up-img { width: 320px; animation: levelUpZoom 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes levelUpZoom { from { transform: scale(0); } to { transform: scale(1); } }
        #notification-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(20, 10, 5, 0.9); border: 2px solid var(--text-gold); padding: 10px 30px; border-radius: 20px; color: var(--text-gold); font-size: 1.2rem; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 3000; }
        #item-get-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 9998; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; flex-direction: column; }
        .item-card-anim { background: rgba(40,30,20,0.95); border: 3px solid var(--text-gold); padding: 30px; text-align: center; border-radius: 10px; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .loading-text { color: var(--text-gold); font-size: 1.5rem; margin-top: 20px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

<div id="loading-overlay">
    <img src="https://html-classic.itch.zone/html/16280602/%E6%AD%A6%E4%BF%A0%E7%AD%94%E9%A1%8C%E5%82%B3/images/ui/icon_shop_pixel.png" width="80">
    <div class="loading-text">å®—é–€è³‡æºè¼‰å…¥ä¸­...</div>
</div>

<div id="app-container">
    <header class="pixel-border">
        <div style="display: flex; align-items: center; gap: 15px;">
            <img id="header-icon" src="" width="40" alt="Icon">
            <h1>å®—é–€åéŒ„</h1>
        </div>
        <div class="controls">
            <button class="pixel-btn" id="musicBtn" onclick="toggleMusic()">ğŸ”‡ éŸ³æ¨‚</button>
            <button class="pixel-btn gold" onclick="openShopDirect()">ğŸ’° è¬å¯¶é–£</button>
            <button class="pixel-btn gold" onclick="openLeaderboard()">ğŸ† æˆ°åŠ›æ¦œ</button>
            <button class="pixel-btn" onclick="openBattleModal()">âš”ï¸ éš¨æ©Ÿæ­·ç·´</button>
            <div style="width: 20px;"></div>
            
            <button id="loginBtn" class="pixel-btn" onclick="toggleTeacherMode()">ğŸ”‘ å¸«å°Šç™»å…¥</button>
            <div class="teacher-only teacher-controls-header" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="text" id="newStudentName" placeholder="è¼¸å…¥å¼Ÿå­åè™Ÿ" style="width:100px;">
                <div class="gender-radio">
                    <label><input type="radio" name="newStudentGender" value="male" checked>ç”·</label>
                    <label><input type="radio" name="newStudentGender" value="female">å¥³</label>
                </div>
                <button class="pixel-btn success" onclick="addStudent()">æ‹›æ”¶</button>
                <button class="pixel-btn info" onclick="openBatchModal()">ğŸ“š æ‰¹é‡</button>
                <button class="pixel-btn" onclick="saveData()">ğŸ’¾ å­˜æª”</button>
                <button class="pixel-btn" style="background:#581212;" onclick="resetAll()">ğŸ’€ é‡ç½®</button>
            </div>
        </div>
    </header>

    <div class="grid-container" id="studentGrid"></div>
</div>

<!-- æˆ°é¬¥æ¨¡æ…‹æ¡† -->
<div id="battle-modal">
    <div id="battle-stage" class="pixel-border">
        <div class="flash-overlay" id="battle-flash"></div>
        <div class="battle-top">
            <div class="fighter" id="fighter-student" style="opacity: 0;">
                <div class="fighter-name" id="battle-student-name">å¼Ÿå­</div>
                <img id="battle-student-img" src="" alt="Student">
            </div>
            <div class="fighter">
                <div class="fighter-name" id="battle-monster-name">å¦–ç¸</div>
                <img id="battle-monster-img" src="" alt="Monster">
            </div>
        </div>
        <div id="battle-ui" class="pixel-border">
            <p id="battle-msg">é­é‡äº†é‡ç”Ÿå¦–ç¸ï¼</p>
            <div class="battle-controls" id="battle-controls-start">
                <button class="pixel-btn primary" style="font-size: 1.2rem; padding: 10px 30px;" onclick="pickRandomStudent()">ğŸ² éš¨æ©Ÿé»åè¿æˆ°</button>
                <button class="pixel-btn" onclick="closeBattleModal()">é€ƒè·‘ (é—œé–‰)</button>
            </div>
            <div class="battle-controls" id="battle-controls-judge" style="display: none;">
                <div class="teacher-controls-flex" style="display: flex; gap: 20px;">
                    <button class="pixel-btn success" onclick="resolveBattle(true)">âœ… å›ç­”æ­£ç¢º (æ–¬æ®º)</button>
                    <button class="pixel-btn primary" onclick="resolveBattle(false)">âŒ å›ç­”éŒ¯èª¤ (å—å‚·)</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ’è¡Œæ¦œæ¨¡æ…‹æ¡† -->
<div id="leaderboard-modal">
    <div class="pixel-border" style="background:var(--panel-bg); padding:20px; width:450px; max-height:80vh; display:flex; flex-direction:column; gap:10px;">
        <h2 style="margin:0; color:var(--text-gold); text-align:center; text-shadow: 2px 2px 0 #000;">ğŸ† å®—é–€æˆ°åŠ›æ¦œ</h2>
        <div style="display:flex; justify-content:space-between; padding:0 10px; color:var(--text-brown); border-bottom:1px solid #503010;">
            <span>æ’å / å¼Ÿå­</span><span>æˆ°é¬¥åŠ› (CP)</span>
        </div>
        <div id="lb-container" style="flex-grow:1; overflow-y:auto;"></div>
        <button class="pixel-btn" onclick="document.getElementById('leaderboard-modal').style.display='none'">é—œé–‰</button>
    </div>
</div>

<!-- è¬å¯¶é–£æ¨¡æ…‹æ¡† -->
<div id="shop-modal">
    <div class="pixel-border" style="background:var(--panel-bg); padding:20px; width:760px; max-height:82vh; display:flex; flex-direction:column; gap:12px;">
        <h2 style="margin:0; color:var(--text-gold); text-align:center;">ğŸ’° è¬å¯¶é–£</h2>
        <div class="shop-select-row" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center;">
            <span class="label-tag">è³¼è²·äºº</span>
            <select id="shop-student-select" onchange="switchShopStudent()"></select>
            <span id="shop-balance-display" class="label-tag">å¦–ä¸¹ 0</span>
            <span class="shop-note">å¯µç‰©åƒ…èƒ½åœ¨æ­¤è³¼è²·ï¼›æ‰“å¯¶ä¸æœƒæ‰å¯µç‰©ã€‚</span>
        </div>
        <div class="shop-tabs">
            <div class="shop-tab active" data-tab="gear" onclick="switchShopTab('gear')">ç¥å…µ / éˆç¸</div>
            <div class="shop-tab" data-tab="reward" onclick="switchShopTab('reward')">æ ¡åœ’ç‰¹æ¬Šå¡</div>
            <div class="shop-tab" data-tab="title" onclick="switchShopTab('title')">å®—é–€ç¨±è™Ÿ</div>
        </div>
        <div id="shop-container" class="shop-grid"></div>
        <button class="pixel-btn" onclick="document.getElementById('shop-modal').style.display='none'">é›¢é–‹</button>
    </div>
</div>

<!-- è¡Œå›Šæ¨¡æ…‹æ¡† -->
<div id="inventory-modal">
    <div class="pixel-border" style="background:var(--panel-bg); padding:20px; width:420px; max-height:80vh; display:flex; flex-direction:column; gap:15px;">
        <h3 id="inv-modal-title" style="margin:0; color:var(--text-gold); text-align:center;">å¼Ÿå­çš„è¡Œå›Š</h3>
        <p style="text-align:center; color:#aaa; font-size:0.8rem; margin:0;">(è£å‚™é»æ“Šç©¿æˆ´ï¼›ç‰¹æ¬Šå¡é»æ“Šä½¿ç”¨)</p>
        <div id="inv-container" class="inventory-grid"></div>
        <div style="display:flex; justify-content:center; gap:10px;">
            <button class="pixel-btn gold" onclick="openShopForCurrent()">ğŸ’° å‰å¾€è¬å¯¶é–£</button>
            <button class="pixel-btn" onclick="document.getElementById('inventory-modal').style.display='none'">é—œé–‰</button>
        </div>
    </div>
</div>

<!-- æ‰¹é‡ç”Ÿæˆæ¨¡æ…‹æ¡† -->
<div id="batch-modal">
    <div class="pixel-border" style="background:var(--panel-bg); padding:20px; width:300px; text-align:center; display:flex; flex-direction:column; gap:15px;">
        <h3 style="margin:0; color:var(--text-gold);">æ‰¹é‡ç”Ÿæˆç­ç´š</h3>
        <p style="color:var(--text-beige); margin:0;">è«‹è¼¸å…¥ç­ç´šäººæ•¸ (å°‡ç”Ÿæˆ 1è™Ÿ~Nè™Ÿ)</p>
        <input type="number" id="batch-count" min="1" max="100" value="30" style="text-align:center;">
        <div style="display:flex; justify-content:center; gap:10px;">
            <button class="pixel-btn" onclick="document.getElementById('batch-modal').style.display='none'">å–æ¶ˆ</button>
            <button class="pixel-btn success" onclick="confirmBatchAdd()">ç”Ÿæˆ</button>
        </div>
    </div>
</div>

<!-- ç·¨è¼¯å­¸ç”Ÿæ¨¡æ…‹æ¡† -->
<div id="edit-student-modal">
    <div class="pixel-border" style="background:var(--panel-bg); padding:20px; width:300px; display:flex; flex-direction:column; gap:15px;">
        <h3 style="margin:0; color:var(--text-gold); text-align:center;">ç·¨è¼¯å¼Ÿå­è³‡æ–™</h3>
        <input type="hidden" id="edit-id">
        <div><label style="color:var(--text-brown);">åè™Ÿ:</label><input type="text" id="edit-name" style="width:100%; margin-top:5px;"></div>
        <div><label style="color:var(--text-brown);">ç¨±è™Ÿ (é¸å¡«):</label><input type="text" id="edit-title" placeholder="å¦‚: è­·æ³•, ç¡ç¥" style="width:100%; margin-top:5px;"></div>
        <div>
            <label style="color:var(--text-brown);">æ€§åˆ¥:</label>
            <div class="gender-radio" style="margin-top:5px;">
                <label><input type="radio" name="editGender" value="male">å°‘ä¿  (ç”·)</label>
                <label><input type="radio" name="editGender" value="female">å¥³ä¿  (å¥³)</label>
            </div>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:10px;">
            <button class="pixel-btn" style="background:#581212;" onclick="confirmDeleteStudent()">ğŸ—‘ï¸ é€å‡º</button>
            <div>
                <button class="pixel-btn" onclick="document.getElementById('edit-student-modal').style.display='none'">å–æ¶ˆ</button>
                <button class="pixel-btn success" onclick="saveStudentEdit()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- ç²å¾—é“å…·æç¤º -->
<div id="item-get-overlay">
        <div class="item-card-anim">
            <h2 style="color:var(--text-gold); margin:0 0 10px 0;">âœ¨ æ©Ÿç·£å·²åˆ° âœ¨</h2>
            <img id="item-get-img" src="" style="width:100px; height:100px; image-rendering:pixelated; border:2px solid #fff; border-radius:5px; background:rgba(0,0,0,0.5);">
            <p id="item-get-name" style="color:var(--text-beige); font-size:1.5rem; margin:10px 0;">ç²å¾— ç¥ç¸ï¼</p>
            <p id="item-get-desc" style="color:var(--text-brown); font-size:1rem; margin:0;">æˆåŠŸæ”¶æœäº†å¦–ç¸ï¼</p>
        <br><button class="pixel-btn success" onclick="document.getElementById('item-get-overlay').style.display='none'">æ”¶ä¸‹</button>
    </div>
</div>

<!-- ç³»çµ±æç¤ºæ¨¡æ…‹æ¡† -->
<div id="system-modal">
    <div class="pixel-border" style="background:var(--panel-bg); padding:20px; width:300px; text-align:center; display:flex; flex-direction:column; gap:15px;">
        <h3 id="modal-title" style="margin:0; color:var(--text-gold);">æç¤º</h3>
        <p id="modal-msg" style="margin:0; color:var(--text-beige);"></p>
        <div id="modal-input-container" style="display:none;"><input type="text" id="modal-input" style="width:90%; font-size:1.1rem; text-align:center; padding: 5px;"></div>
        <div style="display:flex; justify-content:center; gap:10px; margin-top:5px;">
            <button id="modal-cancel-btn" class="pixel-btn" style="display:none;">å–æ¶ˆ</button>
            <button id="modal-confirm-btn" class="pixel-btn success">ç¢ºå®š</button>
        </div>
    </div>
</div>

<!-- ç¨±è™Ÿæˆäºˆæ¨¡æ…‹æ¡† -->
<div id="title-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:2100; justify-content:center; align-items:center;">
    <div class="pixel-border" style="background:var(--panel-bg); padding:18px; width:620px; max-height:80vh; overflow:auto; display:flex; flex-direction:column; gap:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 id="title-modal-title" style="margin:0; color:var(--text-gold);">æˆäºˆç¨±è™Ÿ</h3>
            <button class="pixel-btn" onclick="document.getElementById('title-modal').style.display='none'">é—œé–‰</button>
        </div>
        <div id="title-card-container" class="shop-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px,1fr));"></div>
        <div style="text-align:right;"><button class="pixel-btn success" onclick="grantSelectedTitle()">æˆäºˆ</button></div>
    </div>
</div>

<div id="level-up-overlay"><img id="level-up-img" src="" alt="Level Up"></div>
<div id="notification-bar">ç³»çµ±æç¤º</div>

<script>
    const BASE_URL = "https://html-classic.itch.zone/html/16280602/%E6%AD%A6%E4%BF%A0%E7%AD%94%E9%A1%8C%E5%82%B3/";
    document.body.style.backgroundImage = `url('${BASE_URL}images/title_background_inkwash.jpg')`;
    document.getElementById('header-icon').src = BASE_URL + "images/ui/icon_shop_pixel.png";
    document.getElementById('level-up-img').src = BASE_URL + "images/effects/effect_levelup_animation.gif";

    const sfxClick = new Audio(BASE_URL + 'audio/sfx_button_click.mp3');
    const sfxLevelUp = new Audio(BASE_URL + 'audio/sfx_level_up.mp3');
    const sfxWin = new Audio(BASE_URL + 'audio/sfx_battle_win.mp3');
    const sfxAttack = new Audio(BASE_URL + 'audio/sfx_player_attack.mp3');
    const sfxGetItem = new Audio(BASE_URL + 'audio/sfx_buy_item.mp3'); 
    const bgmMain = new Audio(BASE_URL + 'audio/bgm_main_game.mp3'); bgmMain.loop = true; bgmMain.volume = 0.3;
    const bgmBattle = new Audio(BASE_URL + 'audio/bgm_battle.mp3'); bgmBattle.loop = true; bgmBattle.volume = 0.3;
    let isMusicEnabled = false;
    function playSfx(audio) { try { audio.currentTime = 0; audio.play().catch(() => {}); } catch(e) {} }
    function toggleMusic() { isMusicEnabled = !isMusicEnabled; const btn = document.getElementById('musicBtn'); if (isMusicEnabled) { btn.innerText = "ğŸµ éŸ³æ¨‚"; playBGM('main'); } else { btn.innerText = "ğŸ”‡ éŸ³æ¨‚"; stopBGM(); } }
    function playBGM(type) { if (!isMusicEnabled) return; bgmMain.pause(); bgmBattle.pause(); try { if (type === 'main') bgmMain.play().catch(()=>{}); else if (type === 'battle') { bgmBattle.currentTime = 0; bgmBattle.play().catch(()=>{}); } } catch(e) {} }
    function stopBGM() { bgmMain.pause(); bgmBattle.pause(); }
    document.addEventListener('click', () => { if (isMusicEnabled && bgmMain.paused && bgmBattle.paused && document.getElementById('battle-modal').style.display === 'none') playBGM('main'); }, {once:true});

    // é€šç”¨ç³»çµ±å½ˆçª—
    function showCustomModal({ title, msg, hasInput = false, isPassword = false, showCancel = false, onConfirm }) {
        const modal = document.getElementById('system-modal');
        document.getElementById('modal-title').innerText = title || "æç¤º";
        document.getElementById('modal-msg').innerText = msg || "";
        const inputContainer = document.getElementById('modal-input-container');
        const input = document.getElementById('modal-input');
        
        if (hasInput) {
            inputContainer.style.display = 'block'; input.value = ''; input.type = isPassword ? 'password' : 'text';
            setTimeout(() => input.focus(), 100);
        } else { inputContainer.style.display = 'none'; }

        const cancelBtn = document.getElementById('modal-cancel-btn');
        cancelBtn.style.display = showCancel ? 'block' : 'none';
        cancelBtn.onclick = () => modal.style.display = 'none';

        const confirmBtn = document.getElementById('modal-confirm-btn');
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        newConfirmBtn.onclick = () => {
            modal.style.display = 'none';
            if (onConfirm) onConfirm(hasInput ? input.value : true);
        };
        if (hasInput) input.onkeydown = (e) => { if (e.key === 'Enter') newConfirmBtn.click(); };
        modal.style.display = 'flex';
    }

    const BATTLE_BG = [
        BASE_URL + "images/backgrounds/battle_pixel_background.jpg",
        BASE_URL + "images/backgrounds/battle_forest_pixel.jpg",
        BASE_URL + "images/backgrounds/battle_cave_pixel.jpg",
        BASE_URL + "images/backgrounds/battle_volcano_pixel.jpg",
        BASE_URL + "images/backgrounds/battle_ruins_pixel.jpg",
        BASE_URL + "images/backgrounds/battle_frozen_peak_pixel.jpg"
    ];

    // æ­¦å™¨èˆ‡è¬å¯¶é–£å°ˆå±¬å¯µç‰©
    const ITEMS = {
        sword_fire:  { id:'sword_fire',  name:"ç‚é™½åŠ", type:'sword', src: BASE_URL+"images/swords/sword_fire_sprite.png",  icon: BASE_URL+"images/swords/sword_fire_icon.png",  cp:320, price:380, desc:"ç†¾ç†±åŠé‹’ï¼Œç¼ç‡’æ•µäººã€‚", stats:{atk:48,crit:6} },
        sword_wood:  { id:'sword_wood',  name:"é’æœ¨åŠ", type:'sword', src: BASE_URL+"images/swords/sword_wood_sprite.png",  icon: BASE_URL+"images/swords/sword_wood_icon.png",  cp:240, price:260, desc:"éˆæœ¨æ·¬éŠï¼Œç©©å®šå¢ç›Šã€‚", stats:{atk:30,def:10} },
        sword_gold:  { id:'sword_gold',  name:"éŠ³é‡‘åŠ", type:'sword', src: BASE_URL+"images/swords/sword_gold_sprite.png",  icon: BASE_URL+"images/swords/sword_gold_icon.png",  cp:300, price:320, desc:"ç ´ç”²åˆ©å™¨ï¼Œæš´æ“ŠåŠ æˆã€‚", stats:{atk:46,crit:8} },
        sword_ice:   { id:'sword_ice',   name:"å†°æ™¶åŠ", type:'sword', src: BASE_URL+"images/swords/sword_ice_sprite.png",   icon: BASE_URL+"images/swords/sword_ice_icon.png",   cp:260, price:300, desc:"å¯’éœœå°é‹’ï¼Œç©©å®šé˜²ç¦¦ã€‚", stats:{atk:34,def:8} },
        sword_light: { id:'sword_light', name:"æ™¨æ›¦åŠ", type:'sword', src: BASE_URL+"images/swords/sword_light_sprite.png", icon: BASE_URL+"images/swords/sword_light_icon.png", cp:380, price:420, desc:"æ›™å…‰åŠ æŒï¼Œè¶…é«˜çˆ†æ“Šã€‚", stats:{atk:55,crit:12} },
        pet_kunpeng: { id:'pet_kunpeng', name:"ç¥ç¸é¯¤éµ¬", type:'pet',  src: BASE_URL+"images/pets/kunpeng_sprite.gif", icon: BASE_URL+"images/pets/kunpeng_icon.png", cp:2500, price:3000, desc:"æŒ¯ç¿…ä¹å¤©ï¼Œé€Ÿåº¦èˆ‡æ°£å‹¢å…¼å‚™ã€‚" },
        pet_zhuque:  { id:'pet_zhuque',  name:"ç¥ç¸æœ±é›€", type:'pet',  src: BASE_URL+"images/pets/zhuque_sprite.gif",  icon: BASE_URL+"images/pets/zhuque_icon.png",  cp:2500, price:3000, desc:"ç‚ç¾½è­·ä¸»ï¼Œå¢å¼·çˆ†ç™¼ã€‚" },
        pet_qinglong:{ id:'pet_qinglong',name:"ç¥ç¸é’é¾", type:'pet',  src: BASE_URL+"images/pets/qinglong_sprite.gif", icon: BASE_URL+"images/pets/qinglong_icon.png", cp:2500, price:3000, desc:"é¾å¨åŠ æŒï¼Œå…¨é¢æå‡æˆ°åŠ›ã€‚" },
        pet_whelp:   { id:'pet_whelp',   name:"å¹½å†¥å¹¼é¾", type:'pet',  src: BASE_URL+"images/pets/pet_nether_whelp_sprite.gif", icon: BASE_URL+"images/pets/pet_nether_whelp_icon.png", cp:3000, price:3600, desc:"å†¥ç‚çºç¹ï¼Œå±¬æ€§å…¨é¢æå‡ã€‚" }
    };

    // ç¨±è™Ÿç³»çµ±
    const TITLES = {
        novice:   { id:'novice',   name:'è¦‹ç¿’å¼Ÿå­',   bonus:{ cp:20 }, desc:'åˆå…¥å®—é–€ï¼ŒåŠªåŠ›ä¿®è¡Œã€‚' },
        honor:    { id:'honor',    name:'å®—é–€è­·è¡›',   bonus:{ cp:80 }, desc:'å®ˆè­·åŒé–€ï¼Œå¨æœ›æå‡ã€‚' },
        scholar:  { id:'scholar',  name:'è—ç¶“æ¨“å­¸å£«', bonus:{ cp:120 }, desc:'å­¸è­˜æ·µåšï¼Œå¢å¼·æ‚Ÿæ€§ã€‚' },
        blade:    { id:'blade',    name:'åŠé–£è¡Œè€…',   bonus:{ cp:180 }, desc:'åŠæ„å‡œç„¶ï¼Œæˆ°åŠ›ç²¾é€²ã€‚' },
        legend:   { id:'legend',   name:'å‚³å¥‡æ¦œçœ¼',   bonus:{ cp:260 }, desc:'æ¦®ç™»æ¦œçœ¼ï¼Œå®—é–€æ¦®è€€ã€‚' }
    };

    // æ ¡åœ’ç‰¹æ¬Šå¡ï¼ˆè²¼è¿‘å°ç£å­¸ç”Ÿä¸”éè«‹å®¢ï¼Œç§»é™¤åŠ åˆ†åˆ¸ï¼‰
    const REAL_REWARDS = [
        { id: 'card_vocab',     name: 'æ¸›å­—è¨£',     type: 'consumable', icon: BASE_URL + 'images/ui/icon_scroll_pixel.png', price: 800,  desc: "ä½œæ¥­æˆ–åœˆè©å¯å°‘å¯«ä¸€é" },
        { id: 'card_nap',       name: 'é€é™åˆä¼‘',   type: 'consumable', icon: BASE_URL + 'images/monsters/placeholder_monster.gif', price: 500, desc: "åˆä¼‘/æ—©è‡ªç¿’å¯å®‰éœè¶´ç¡ä¸€æ¬¡" },
        { id: 'card_seat',      name: 'ç§»å½¢æ›ä½',   type: 'consumable', icon: BASE_URL + 'images/ui/icon_bag_pixel.png', price: 2500, desc: "ä¸‹é€±å„ªå…ˆé¸æ“‡åº§ä½ä¸€æ¬¡" },
        { id: 'card_pardon',    name: 'å…æ­»é‡‘ç‰Œ',   type: 'consumable', icon: BASE_URL + 'images/ui/icon_save_pixel.png', price: 3000, desc: "æŠµéŠ·ä¸€æ¬¡å°ç¼ºé»æˆ–è™•ç½°" },
        { id: 'card_late',      name: 'é›²å½±æ­¥',     type: 'consumable', icon: BASE_URL + 'images/ui/icon_reward_pixel.png', price: 1200, desc: "ä¸€æ¬¡å°é²åˆ°è£œæ•‘ï¼Œè¨˜éŒ„ä¸åˆ—å…¥" },
        { id: 'card_extension', name: 'ç·©è¡ç¬¦',     type: 'consumable', icon: BASE_URL + 'images/ui/icon_scroll_pixel.png', price: 1500, desc: "ä¸€æ¬¡ä½œæ¥­æˆ–å ±å‘Šå¯é †å»¶ä¸€å¤©ç¹³äº¤" },
        { id: 'card_cleanup',   name: 'é¢¨æ¸…æƒ',     type: 'consumable', icon: BASE_URL + 'images/ui/icon_bag_pixel.png', price: 900,  desc: "ä¸€æ¬¡å€¼æ—¥/æ‰“æƒå¯æ›ç­åŒå­¸ä»£ç­ï¼ˆéœ€è€å¸«åŒæ„ï¼‰" }
    ];

    const PLAYER_ARTS = [
        BASE_URL + "images/characters/player/full/player_art_1-10.png",
        BASE_URL + "images/characters/player/full/player_art_11-20.png",
        BASE_URL + "images/characters/player/full/player_art_21-30.png",
        BASE_URL + "images/characters/player/full/player_art_31-40.png"
    ];
    const PLAYER_BATTLE_ARTS = [
        BASE_URL + "images/characters/player/battle/player_battle_1-10.png",
        BASE_URL + "images/characters/player/battle/player_battle_11-20.png",
        BASE_URL + "images/characters/player/battle/player_battle_21-30.png",
        BASE_URL + "images/characters/player/battle/player_battle_31-40.png"
    ];

    // æˆ°é¬¥æ€ªç‰©ï¼ˆåƒ…æˆ°é¬¥ç”¨ï¼Œä¸æ‰å¯µç‰©ï¼‰
    const MONSTERS = [
        { id: 'wolf', name: "å¹¼ç‹¼å¦–", src: BASE_URL + "images/monsters/wolf_cub.gif", icon: BASE_URL + "images/monsters/wolf_cub.gif", cp: 100 },
        { id: 'wolf_elite', name: "ç²¾è‹±ç‹¼å¦–", src: BASE_URL + "images/monsters/wolf_cub_elite.gif", icon: BASE_URL + "images/monsters/wolf_cub_elite.gif", cp: 200 },
        { id: 'snake', name: "å°ç«¹è‘‰é’", src: BASE_URL + "images/monsters/snakelet_bamboo.gif", icon: BASE_URL + "images/monsters/snakelet_bamboo.gif", cp: 120 },
        { id: 'boar', name: "ç™¼æ€’é‡è±¬", src: BASE_URL + "images/monsters/boar_angry.gif", icon: BASE_URL + "images/monsters/boar_angry.gif", cp: 300 },
        { id: 'golem', name: "çŸ³å¶", src: BASE_URL + "images/monsters/stone_golem.gif", icon: BASE_URL + "images/monsters/stone_golem.gif", cp: 400 },
        { id: 'imp', name: "è©­å½±å°å¦–", src: BASE_URL + "images/monsters/shadow_imp.gif", icon: BASE_URL + "images/monsters/shadow_imp.gif", cp: 350 },
        { id: 'eye', name: "æµ®ç©ºé­”çœ¼", src: BASE_URL + "images/monsters/flying_eye.gif", icon: BASE_URL + "images/monsters/flying_eye.gif", cp: 450 }
    ];

    let students = JSON.parse(localStorage.getItem('wuxia_class_data')) || [];
    let currentBattleStudentIndex = -1;
    let currentMonster = null;
    let isTeacherMode = false;
    let isTreasureEncounter = false;
    let currentInvStudentIndex = -1; 
    let shopTab = 'gear';
    let titleTargetIndex = -1;
    let selectedTitleId = null;

    // é è¼‰è³‡æº
    function preloadAssets() {
        const assets = [
            ...BATTLE_BG, ...PLAYER_ARTS, ...PLAYER_BATTLE_ARTS,
            ...MONSTERS.map(m => m.src), ...Object.values(ITEMS).map(w => w.src),
            BASE_URL + "images/monsters/placeholder_monster.gif" 
        ];
        const allAssets = [];
        assets.forEach(url => {
            allAssets.push(url);
            if (url.includes('player_')) {
                allAssets.push(url.replace('.png', '_girl.png'));
                allAssets.push(url.replace('_battle', '_battle_portrait'));
            }
        });
        let loadedCount = 0; const total = allAssets.length;
        const overlay = document.getElementById('loading-overlay');
        if(total === 0) { overlay.style.display = 'none'; return; }
        allAssets.forEach(src => { const img = new Image(); img.onload = img.onerror = () => { loadedCount++; if(loadedCount >= total) setTimeout(() => { overlay.style.display = 'none'; }, 500); }; img.src = src; });
        setTimeout(() => { overlay.style.display = 'none'; }, 5000);
    }

    window.onload = () => { 
        students = (students || []).map(normalizeStudent);
        preloadAssets();
        renderGrid(); 
        updateTeacherUI(); 
    };

    function normalizeStudent(s) {
        const base = { id: Date.now(), name: 'å¼Ÿå­', gender: 'male', exp: 0, coins: 0, title: "", inventory: [], equipped: {} };
        if (typeof s.points !== 'undefined' && typeof s.coins === 'undefined') base.coins = s.points; // å…¼å®¹èˆŠç‰ˆå¦–ä¸¹æ¬„ä½
        return Object.assign(base, s || {});
    }

    function getAvatarPath(path, gender) { return gender === 'female' ? path.replace('.png', '_girl.png').replace('.gif', '_girl.gif') : path; }
    function calculateLevel(exp) { if (exp <= 0) return 1; return Math.floor(Math.sqrt(exp / 5)) + 1; }
    function getExpForLevel(level) { return 5 * Math.pow(level, 2); }

    function calculateCP(student) {
        const lvl = calculateLevel(student.exp);
        let cp = (lvl * 100) + Math.floor(student.exp * 0.1);
        if (student.equipped) {
            if (student.equipped.pet) { const item = getItemData(student.equipped.pet); if(item) cp += (item.cp || 300); }
            if (student.equipped.sword) { const item = getItemData(student.equipped.sword); if(item) cp += (item.cp || 500); }
        }
        if (student.title && TITLES[student.title]) cp += TITLES[student.title].bonus?.cp || 0;
        return cp;
    }

    function getItemData(itemId) {
        if (ITEMS[itemId]) return ITEMS[itemId];
        const real = REAL_REWARDS.find(r => itemId.startsWith(r.id));
        if (real) return real;
        if (itemId.startsWith("tamed_")) { // èˆŠç‰ˆæˆ°å¯µï¼Œå·²ä¸å†æ‰è½
            const monsterType = itemId.split('_')[1];
            const m = MONSTERS.find(x => x.id === monsterType);
            if(m) return { id:itemId, name: "é¦´æœçš„"+m.name, cp: m.cp || 200, icon: m.icon, type: 'pet', desc:"èˆŠç‰ˆæˆ°å¯µ" };
        }
        return null;
    }

    function getStudentInfo(s) {
        const currentLevel = calculateLevel(s.exp);
        const nextLevelExp = getExpForLevel(currentLevel);
        const prevLevelExp = getExpForLevel(currentLevel - 1);
        const range = nextLevelExp - prevLevelExp;
        const progress = s.exp - prevLevelExp;
        const pct = Math.min(100, Math.max(0, (progress / range) * 100));
        let artIndex = 0; if (currentLevel < 25) artIndex = 0; else if (currentLevel < 50) artIndex = 1; else if (currentLevel < 75) artIndex = 2; else artIndex = 3;
        const gender = s.gender || 'male';
        return { level: currentLevel, avatar: getAvatarPath(PLAYER_ARTS[artIndex], gender), battleAvatar: getAvatarPath(PLAYER_BATTLE_ARTS[artIndex], gender), expText: `${s.exp} / ${nextLevelExp}`, pct };
    }

    function updateExp(index, amount) {
        playSfx(sfxClick);
        const s = students[index]; 
        const oldLvl = calculateLevel(s.exp);
        s.exp = Math.max(0, s.exp + amount);
        const newLvl = calculateLevel(s.exp);
        showFloatText(amount > 0 ? `+${amount} Exp` : `${amount}`, index);
        if (newLvl > oldLvl) { playSfx(sfxLevelUp); showLevelUpEffect(); showNotify(`æ­å–œ ${s.name} å‡åˆ°äº† Lv.${newLvl}ï¼`); }
        saveData(); renderGrid();
    }

    function toggleTeacherMode() {
        if (!isTeacherMode) {
            showCustomModal({
                title: "å¸«å°Šé©—è­‰", msg: "è«‹è¼¸å…¥å£ä»¤ (é è¨­: admin)", hasInput: true, isPassword: true, showCancel: true,
                onConfirm: (val) => {
                    if (val === "admin" || val === "å¸«å°Š" || val === "1234") {
                        isTeacherMode = true; document.getElementById('loginBtn').innerText = "ğŸ”“ å¸«å°Šç™»å‡º";
                        showNotify("å¸«å°Šé™è‡¨ï¼Œæ¬Šé™å·²è§£é–ï¼");
                        updateTeacherUI();
                    } else { showNotify("å£ä»¤éŒ¯èª¤ï¼"); }
                }
            });
        } else { isTeacherMode = false; document.getElementById('loginBtn').innerText = "ğŸ”‘ å¸«å°Šç™»å…¥"; showNotify("å·²åˆ‡æ›å›å¼Ÿå­è¦–è§’ã€‚"); updateTeacherUI(); }
    }

    function updateTeacherUI() {
        const teacherElements = document.querySelectorAll('.teacher-only');
        teacherElements.forEach(el => { if (isTeacherMode) { if (el.classList.contains('card-actions')) el.style.setProperty('display', 'grid', 'important'); else if (el.classList.contains('teacher-controls-header')) el.style.setProperty('display', 'flex', 'important'); else el.style.setProperty('display', 'block', 'important'); } else el.style.setProperty('display', 'none', 'important'); });
    }

    // æ’è¡Œæ¦œ
    function openLeaderboard() {
        playSfx(sfxClick);
        const modal = document.getElementById('leaderboard-modal');
        const container = document.getElementById('lb-container');
        container.innerHTML = '';
        let sortedStudents = [...students].sort((a, b) => calculateCP(b) - calculateCP(a));
        if (sortedStudents.length === 0) { container.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">æš«ç„¡å¼Ÿå­æ•¸æ“š</div>'; }
        else {
            sortedStudents.forEach((s, i) => {
                const info = getStudentInfo(s);
                const cp = calculateCP(s);
                const row = document.createElement('div');
                row.className = `leaderboard-row rank-${i+1}`;
                row.innerHTML = `
                    <div class="rank-num">${i+1}</div>
                    <img class="lb-avatar" src="${info.avatar}">
                    <div class="lb-name">${s.name} ${s.title ? `<span class="title-badge">${s.title}</span>` : ''} <span style="font-size:0.8em; color:#aaa;">Lv.${info.level}</span></div>
                    <div class="lb-cp">${cp}</div>`;
                container.appendChild(row);
            });
        }
        modal.style.display = 'flex';
    }

    // è¬å¯¶é–£
    function openShopDirect() { // è‹¥æœªé¸å­¸ç”Ÿå‰‡é è¨­ç¬¬ä¸€ä½
        if (students.length === 0) { showNotify("å…ˆæ”¶å¼Ÿå­å†ä¾†è¬å¯¶é–£ï¼"); return; }
        currentInvStudentIndex = currentInvStudentIndex === -1 ? 0 : currentInvStudentIndex;
        openShopModal();
    }

    function openShopForCurrent() {
        if (currentInvStudentIndex === -1) { showNotify("è«‹å…ˆé–‹å•ŸæŸä½å¼Ÿå­çš„è¡Œå›Š"); return; }
        document.getElementById('inventory-modal').style.display = 'none';
        openShopModal();
    }

    function openShopModal() {
        const selector = document.getElementById('shop-student-select');
        selector.innerHTML = '';
        students.forEach((s, idx) => { const opt = document.createElement('option'); opt.value = idx; opt.innerText = `${s.name} (å¦–ä¸¹ ${s.coins||0})`; selector.appendChild(opt); });
        selector.value = currentInvStudentIndex;
        updateShopBalance();
        renderShop();
        document.getElementById('shop-modal').style.display = 'flex';
    }

    function switchShopStudent() { currentInvStudentIndex = parseInt(document.getElementById('shop-student-select').value); updateShopBalance(); renderShop(); }
    function switchShopTab(tab) { shopTab = tab; document.querySelectorAll('.shop-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab)); renderShop(); }
    function updateShopBalance() { const s = students[currentInvStudentIndex]; document.getElementById('shop-balance-display').innerText = `å¦–ä¸¹ ${s?.coins || 0}`; }

    function renderShop() {
        const container = document.getElementById('shop-container');
        container.innerHTML = '';
        let itemsToShow = [];
        if (shopTab === 'gear') itemsToShow = Object.values(ITEMS);
        else if (shopTab === 'reward') itemsToShow = REAL_REWARDS;
        else itemsToShow = Object.values(TITLES).map(t => ({...t, type:'title', price: 0}));

        itemsToShow.forEach(item => {
            const card = document.createElement('div');
            const cls = item.type === 'pet' ? 'pet' : (item.type === 'consumable' ? 'reward' : '');
            card.className = `shop-card ${cls}`;
            const priceHtml = item.type === 'title' ? '<div class="item-price" style="color:#80ffea;">å¸«å°Šå¯ç›´æ¥æˆäºˆ</div>' : `<div class="item-price">ğŸ’° ${item.price}</div>`;
            const actionBtn = item.type === 'title'
                ? `<button class="pixel-btn info action-btn-small" onclick="grantTitleFromShop('${item.id}')">æˆäºˆ</button>`
                : `<button class="pixel-btn success action-btn-small" onclick="buyItem('${item.id}')">è³¼è²·</button>`;
            card.innerHTML = `
                <img src="${item.icon || item.src || BASE_URL+'images/ui/icon_shop_pixel.png'}">
                <h4>${item.name}</h4>
                <p>${item.desc || ''}</p>
                ${item.bonus?.cp ? `<div class="cp-bonus">æˆ°åŠ› +${item.bonus.cp}</div>` : (item.cp ? `<div class="cp-bonus">æˆ°åŠ› +${item.cp}</div>` : '')}
                ${priceHtml}
                ${actionBtn}`;
            container.appendChild(card);
        });
    }

    function buyItem(itemId) {
        const s = students[currentInvStudentIndex];
        const itemData = getItemData(itemId); 
        if (!itemData) { showNotify("å•†å“ä¸å­˜åœ¨"); return; }
        const price = itemData.price || 0;
        if ((s.coins || 0) < price) { showNotify("å¦–ä¸¹ä¸è¶³ï¼Œå…ˆå»æ­·ç·´è³ºå–ï¼"); return; }
        playSfx(sfxGetItem);
        s.coins = (s.coins || 0) - price;
        if (!s.inventory) s.inventory = [];
        const isConsumable = itemData.type === 'consumable';
        if (isConsumable) {
            const uid = `${itemId}_${Date.now()}`;
            s.inventory.push(uid);
            showNotify("è³¼è²·æˆåŠŸï¼å·²æ”¾å…¥è¡Œå›Šï¼Œè«‹å‘è€å¸«å‡ºç¤ºä½¿ç”¨ã€‚");
        } else {
            if (s.inventory.includes(itemId)) { showNotify("å·²æ“æœ‰æ­¤è£å‚™ï¼Œè³¼è²·å–æ¶ˆã€‚"); s.coins += price; }
            else { s.inventory.push(itemId); showNotify("è³¼è²·æˆåŠŸï¼æˆ°åŠ›å¤§å¢ï¼"); }
        }
        saveData(); updateShopBalance(); renderGrid();
    }

    function grantTitleFromShop(titleId) {
        if (!isTeacherMode) { showNotify("åƒ…å¸«å°Šå¯æˆäºˆç¨±è™Ÿ"); return; }
        const t = TITLES[titleId];
        if (!t) { showNotify("ç¨±è™Ÿä¸å­˜åœ¨"); return; }
        const s = students[currentInvStudentIndex];
        s.title = titleId;
        saveData(); renderGrid(); showNotify(`${s.name} ç²å¾—ç¨±è™Ÿï¼š${t.name}`);
    }

    // è¡Œå›Š
    function openInventory(index) {
        currentInvStudentIndex = index;
        const s = students[index];
        const modal = document.getElementById('inventory-modal');
        document.getElementById('inv-modal-title').innerText = `${s.name} çš„è¡Œå›Š`;
        const container = document.getElementById('inv-container'); container.innerHTML = '';
        if (!s.inventory || s.inventory.length === 0) { container.innerHTML = '<p style="color:#aaa; text-align:center; width:100%;">è¡Œå›Šç©ºç©ºå¦‚ä¹Ÿ...</p>'; }
        else {
            s.inventory.forEach(itemId => {
                const itemData = getItemData(itemId);
                if (itemData) {
                    const isEquipped = (s.equipped && (s.equipped.pet === itemId || s.equipped.sword === itemId));
                    const isConsumable = itemData.type === 'consumable';
                    const div = document.createElement('div');
                    div.className = `inventory-item ${isEquipped ? 'equipped' : ''}`;
                    div.innerHTML = `
                        <img src="${itemData.icon || itemData.src}">
                        <div class="item-tooltip">
                            <b>${itemData.name}</b><br>
                            ${itemData.cp ? `<span class="cp-bonus">æˆ°åŠ› +${itemData.cp}</span><br>` : ''}
                            <span style="font-size:0.8em; color:#ddd;">${itemData.desc || (isConsumable ? 'ç‰¹æ¬Šå¡' : 'é»æ“Šè£å‚™')}</span>
                        </div>`;
                    if (isConsumable) div.onclick = () => useRealReward(index, itemId);
                    else div.onclick = () => toggleEquip(index, itemId, itemData.type);
                    container.appendChild(div);
                }
            });
        }
        modal.style.display = 'flex';
    }

    function toggleEquip(studentIndex, itemId, type) {
        const s = students[studentIndex];
        if (!s.equipped) s.equipped = {};
        if (type === 'pet') s.equipped.pet = (s.equipped.pet === itemId) ? null : itemId;
        else if (type === 'sword') s.equipped.sword = (s.equipped.sword === itemId) ? null : itemId;
        saveData(); renderGrid(); openInventory(studentIndex); 
    }

    function useRealReward(studentIndex, uniqueId) {
        const s = students[studentIndex];
        const baseId = uniqueId.split('_')[0];
        const item = REAL_REWARDS.find(r => baseId === r.id);
        if (!item) return;
        if (confirm(`ç¢ºå®šè¦ä½¿ç”¨ã€${item.name}ã€‘å—ï¼Ÿè«‹å‘è€å¸«å‡ºç¤ºæ­¤ç•«é¢ã€‚`)) {
            s.inventory = s.inventory.filter(id => id !== uniqueId);
            saveData(); openInventory(studentIndex); showNotify(`å·²ä½¿ç”¨ ${item.name}ï¼`);
        }
    }

    // ç¨±è™Ÿæˆäºˆ
    function openTitleModal(index) {
        if (!isTeacherMode) { showNotify("åƒ…å¸«å°Šå¯æˆäºˆç¨±è™Ÿ"); return; }
        titleTargetIndex = index; selectedTitleId = students[index]?.title || null;
        renderTitleCards();
        document.getElementById('title-modal-title').innerText = `æˆäºˆç¨±è™Ÿçµ¦ ${students[index].name}`;
        document.getElementById('title-modal').style.display = 'flex';
    }
    function renderTitleCards() {
        const wrap = document.getElementById('title-card-container'); wrap.innerHTML = '';
        Object.values(TITLES).forEach(t => {
            const card = document.createElement('div');
            card.className = `shop-card ${selectedTitleId === t.id ? 'active' : ''}`;
            card.style.borderColor = selectedTitleId === t.id ? '#ffd700' : '#503010';
            card.innerHTML = `
                <h4>${t.name}</h4>
                <p>${t.desc}</p>
                <div class="cp-bonus">æˆ°åŠ› +${t.bonus?.cp || 0}</div>
                <button class="pixel-btn info action-btn-small" onclick="selectTitle('${t.id}')">${selectedTitleId === t.id ? 'å·²é¸' : 'é¸æ“‡'}</button>
            `;
            wrap.appendChild(card);
        });
    }
    function selectTitle(id) { selectedTitleId = id; renderTitleCards(); }
    function grantSelectedTitle() {
        if (titleTargetIndex < 0 || titleTargetIndex >= students.length) return;
        if (!selectedTitleId) { showNotify("è«‹é¸æ“‡ç¨±è™Ÿ"); return; }
        students[titleTargetIndex].title = selectedTitleId;
        saveData(); renderGrid();
        document.getElementById('title-modal').style.display = 'none';
        showNotify(`${students[titleTargetIndex].name} ç²å¾—ç¨±è™Ÿï¼š${TITLES[selectedTitleId].name}`);
    }

    // å­¸ç”Ÿç®¡ç†
    function addStudent() {
        const input = document.getElementById('newStudentName');
        const name = input.value.trim();
        const genderRadios = document.getElementsByName('newStudentGender');
        let gender = 'male'; for(let r of genderRadios) if(r.checked) gender = r.value;
        if(!name) return;
        playSfx(sfxClick);
        students.push({ id: Date.now(), name, gender, exp: 0, coins: 0, title: "", inventory: [], equipped: {} });
        input.value = ''; saveData(); renderGrid(); showNotify(`æ­¡è¿ ${name} åŠ å…¥å®—é–€ï¼`);
    }

    function openBatchModal() { document.getElementById('batch-modal').style.display = 'flex'; }
    function confirmBatchAdd() {
        const count = parseInt(document.getElementById('batch-count').value);
        if (count > 0 && count <= 100) {
            playSfx(sfxClick);
            for (let i = 1; i <= count; i++) {
                const name = i + "è™Ÿ";
                if (!students.some(s => s.name === name)) students.push({ id: Date.now() + i, name, gender: 'male', exp: 0, coins: 0, title: "", inventory: [], equipped: {} });
            }
            saveData(); renderGrid(); showNotify(`å·²ç”Ÿæˆ ${count} ä½å¼Ÿå­åéŒ„ï¼`);
            document.getElementById('batch-modal').style.display = 'none';
        } else showNotify("è«‹è¼¸å…¥ 1~100 ä¹‹é–“çš„äººæ•¸ã€‚");
    }

    function openEditModal(id) {
        const s = students.find(st => st.id === id); if (!s) return;
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-name').value = s.name;
        document.getElementById('edit-title').value = s.title || "";
        const genderRadios = document.getElementsByName('editGender');
        for(let r of genderRadios) r.checked = (r.value === (s.gender || 'male'));
        document.getElementById('edit-student-modal').style.display = 'flex';
    }

    function saveStudentEdit() {
        const id = parseInt(document.getElementById('edit-id').value);
        const newName = document.getElementById('edit-name').value.trim();
        const newTitle = document.getElementById('edit-title').value.trim();
        const genderRadios = document.getElementsByName('editGender');
        let newGender = 'male'; for(let r of genderRadios) if(r.checked) newGender = r.value;
        const s = students.find(st => st.id === id);
        if (s && newName) { s.name = newName; s.gender = newGender; s.title = newTitle; saveData(); renderGrid(); document.getElementById('edit-student-modal').style.display = 'none'; showNotify("å¼Ÿå­è³‡æ–™å·²æ›´æ–°ï¼"); }
    }

    function confirmDeleteStudent() {
        if(confirm("ç¢ºå®šè¦é€å‡ºæ­¤å¼Ÿå­ï¼Ÿ")) {
            const id = parseInt(document.getElementById('edit-id').value);
            students = students.filter(s => s.id !== id);
            saveData(); renderGrid();
            document.getElementById('edit-student-modal').style.display = 'none';
            showNotify("å¼Ÿå­å·²é›¢é–‹å®—é–€ã€‚");
        }
    }

    function renderGrid() {
        const grid = document.getElementById('studentGrid'); grid.innerHTML = '';
        students.forEach((s, index) => {
            const info = getStudentInfo(s);
            let companionHtml = '';
            if (s.equipped && s.equipped.pet) { const petData = getItemData(s.equipped.pet); if(petData) companionHtml += `<img src="${petData.src || petData.icon}" class="companion-img companion-pet" onerror="this.style.display='none'">`; }
            if (s.equipped && s.equipped.sword) { const swordData = getItemData(s.equipped.sword); if(swordData) companionHtml += `<img src="${swordData.src}" class="companion-img companion-sword">`; }
            const auraClass = info.level >= 70 ? 'aura-high' : (info.level >= 40 ? 'aura-mid' : 'aura-low');
            const card = document.createElement('div'); card.className = 'student-card pixel-border'; card.id = `card-${index}`;
            card.innerHTML = `
                <button class="card-edit-btn teacher-only" onclick="openEditModal(${s.id})">âš™ï¸</button>
                <div class="card-header">
                    <div class="student-name">${s.name} ${s.title ? `<span class="title-badge">${s.title}</span>` : ''}</div>
                    <div class="level-badge">Lv.${info.level}</div>
                </div>
                <div class="avatar-area ${auraClass}">
                    <img src="${info.avatar}" class="avatar-img" onerror="this.src='${PLAYER_ARTS[0]}'">
                    ${companionHtml}
                </div>
                <div class="stat-row"><span class="stat-label">ä¿®ç‚º</span><div class="bar-container"><div class="bar-fill bar-exp" style="width: ${info.pct}%"></div></div><span class="stat-value">${info.expText}</span></div>
                <div class="stat-row"><span class="stat-label">å¦–ä¸¹</span><div class="coin-display">ğŸ’° ${s.coins || 0}</div></div>
                <div class="common-actions"><button class="pixel-btn info action-btn-small" onclick="openInventory(${index})">ğŸ’ è¡Œå›Š</button></div>
                <div class="card-actions teacher-only">
                    <button class="pixel-btn action-btn-small" onclick="updateExp(${index}, 30)">+30 è¡¨ç¾</button>
                    <button class="pixel-btn action-btn-small" onclick="updateExp(${index}, 100)">+100 å„ªç§€</button>
                    <button class="pixel-btn action-btn-small" style="color:#ff6b6b; border-color:#581212" onclick="updateExp(${index}, -30)">-30 æ‰£åˆ†</button>
                    <button class="pixel-btn action-btn-small success" onclick="updateExp(${index}, 300)">+300 å¥‡é‡</button>
                    <button class="pixel-btn action-btn-small info" onclick="openTitleModal(${index})">æˆäºˆç¨±è™Ÿ</button>
                </div>`;
            grid.appendChild(card);
        });
        updateTeacherUI();
    }

    // æˆ°é¬¥
    function openBattleModal() {
        if(students.length === 0) { showNotify("å®—é–€ç„¡äººï¼Œç„¡æ³•æ­·ç·´ï¼"); return; }
        playSfx(sfxClick); playBGM('battle'); 
        const bgUrl = BATTLE_BG[Math.floor(Math.random() * BATTLE_BG.length)];
        document.getElementById('battle-stage').style.backgroundImage = `url('${bgUrl}')`;
        const modal = document.getElementById('battle-modal');
        if (Math.random() < 0.2) { isTreasureEncounter = true; setupTreasureEncounter(); } else { isTreasureEncounter = false; setupMonsterEncounter(); }
        document.getElementById('fighter-student').style.opacity = '0';
        document.getElementById('battle-controls-start').style.display = 'flex';
        document.getElementById('battle-controls-judge').style.display = 'none';
        modal.style.display = 'flex';
    }

    function setupMonsterEncounter() {
        currentMonster = MONSTERS[Math.floor(Math.random() * MONSTERS.length)];
        const monsterImg = document.getElementById('battle-monster-img');
        monsterImg.src = currentMonster.src; monsterImg.className = ''; monsterImg.style.opacity = '1'; 
        monsterImg.onerror = function() { this.src = BASE_URL + "images/monsters/placeholder_monster.gif"; this.onerror = null; };
        document.getElementById('battle-monster-name').innerText = currentMonster.name;
        document.getElementById('battle-msg').innerText = `é­é‡äº†é‡ç”Ÿ ${currentMonster.name}ï¼`;
    }

    function setupTreasureEncounter() {
        currentMonster = null;
        const monsterImg = document.getElementById('battle-monster-img');
        monsterImg.src = BASE_URL + "images/ui/icon_shop_pixel.png";
        monsterImg.className = 'treasure-chest'; monsterImg.style.opacity = '1';
        document.getElementById('battle-monster-name').innerText = "ç¥ç§˜å¯¶ç®±";
        document.getElementById('battle-msg').innerText = `ç™¼ç¾äº†ä¸€å€‹ç¥ç§˜å¯¶ç®±ï¼`;
        spawnBattleFx('lightning');
    }

    function closeBattleModal() { playSfx(sfxClick); playBGM('main'); document.getElementById('battle-modal').style.display = 'none'; }

    function pickRandomStudent() {
        playSfx(sfxClick); 
        document.getElementById('battle-controls-start').style.display = 'none'; 
        document.getElementById('battle-msg').innerText = "å¤©é“è¼ªç›¤è½‰å‹•ä¸­...";
        let speed = 50; let totalTime = 0; const maxTime = 2500;
        (function animateRoll() {
            const randomIdx = Math.floor(Math.random() * students.length);
            const s = students[randomIdx]; const info = getStudentInfo(s);
            currentBattleStudentIndex = randomIdx;
            document.getElementById('battle-student-name').innerText = s.name;
            document.getElementById('battle-student-img').src = info.battleAvatar;
            document.getElementById('fighter-student').style.opacity = '1';
            totalTime += speed;
            if (totalTime < maxTime) { speed += 10; setTimeout(animateRoll, speed); } else finalizePick(s);
        })();
    }

    function finalizePick(student) {
        const flash = document.getElementById('battle-flash'); flash.style.animation = 'flash 0.5s'; setTimeout(() => flash.style.animation = '', 500);
        document.getElementById('battle-msg').innerText = isTreasureEncounter ? `${student.name} å˜—è©¦é–‹å•Ÿå¯¶ç®±ï¼` : `${student.name} æŒºèº«è€Œå‡ºï¼`;
        document.getElementById('battle-controls-judge').style.display = 'block';
        playSfx(sfxLevelUp);
    }

    function resolveBattle(isWin) {
        if(currentBattleStudentIndex === -1) return;
        const monsterImg = document.getElementById('battle-monster-img');
        const studentImg = document.getElementById('battle-student-img');
        const s = students[currentBattleStudentIndex];
        if(isWin) {
            playSfx(sfxWin); monsterImg.classList.add('shake-effect');
            playHitEffect(monsterImg, '#ffd45a');
            let expGain = 50; let coinGain = 50;
            if (isTreasureEncounter) { expGain = 100; coinGain = 200; document.getElementById('battle-msg').innerText = `é–‹å•ŸæˆåŠŸï¼ç²å¾— ${expGain} Exp / ${coinGain} å¦–ä¸¹ï¼`; checkWeaponDrop(currentBattleStudentIndex, true); }
            else { document.getElementById('battle-msg').innerText = `å›ç­”æ­£ç¢ºï¼ç²å¾— ${expGain} Exp / ${coinGain} å¦–ä¸¹ï¼`; checkWeaponDrop(currentBattleStudentIndex, false); }
            updateExp(currentBattleStudentIndex, expGain);
            s.coins = parseInt(s.coins || 0) + coinGain;
            saveData(); renderGrid();
            setTimeout(() => { monsterImg.style.opacity = '0'; setTimeout(closeBattleModal, 1500); }, 500);
        } else {
            playSfx(sfxAttack); studentImg.classList.add('shake-effect');
            playHitEffect(studentImg, '#ff6b6b');
            document.getElementById('battle-msg').innerText = isTreasureEncounter ? "é–‹å•Ÿå¤±æ•—ï¼å¯¶ç®±æ¶ˆå¤±äº†..." : "å›ç­”éŒ¯èª¤ï¼å—åˆ°å‚·å®³ï¼";
            setTimeout(closeBattleModal, 1500);
        }
        document.getElementById('battle-controls-judge').style.display = 'none';
    }

    // æˆ°é¬¥å ´æ™¯å…‰æ•ˆ
    function spawnBattleFx(type='lightning') {
        const stage = document.getElementById('battle-stage');
        const fx = document.createElement('div');
        fx.style.position = 'absolute'; fx.style.inset = '0'; fx.style.pointerEvents = 'none'; fx.style.zIndex = '5';
        if (type === 'lightning') {
            fx.style.background = 'radial-gradient(circle at 60% 20%, rgba(120,180,255,0.35) 0%, rgba(0,0,0,0) 45%)';
            fx.style.animation = 'flash 0.4s ease-out';
        } else if (type === 'fire') {
            fx.style.background = 'radial-gradient(circle at 40% 80%, rgba(255,140,60,0.35) 0%, rgba(0,0,0,0) 45%)';
            fx.style.animation = 'flash 0.6s ease-out';
        }
        stage.appendChild(fx); setTimeout(()=>fx.remove(), 450);
    }

    // æ‰è½ï¼šåƒ…æ­¦å™¨ï¼Œä¸æ‰å¯µç‰©
    function checkWeaponDrop(studentIndex, guaranteed = false) {
        if (guaranteed || Math.random() < 0.05) {
            const keys = Object.keys(ITEMS).filter(k => ITEMS[k].type === 'sword');
            const randomItemKey = keys[Math.floor(Math.random() * keys.length)];
            const s = students[studentIndex];
            if (!s.inventory) s.inventory = [];
            if (!s.inventory.includes(randomItemKey)) {
                s.inventory.push(randomItemKey);
                saveData();
                const item = ITEMS[randomItemKey];
                const overlay = document.getElementById('item-get-overlay');
                document.getElementById('item-get-img').src = item.icon;
                document.getElementById('item-get-name').innerText = `ç²å¾—ç¥å…µï¼š${item.name}ï¼`;
                document.getElementById('item-get-desc').innerText = `æˆ°é¬¥åŠ› +${item.cp}`;
                overlay.style.display = 'flex';
                playSfx(sfxGetItem);
            }
        }
    }

    // æ”»æ“Š / å—æ“Šç‰¹æ•ˆ
    function playHitEffect(targetImg, color = '#ffd700') {
        if (!targetImg || !targetImg.parentElement) return;
        const spark = document.createElement('div');
        spark.className = 'hit-spark';
        spark.style.background = `radial-gradient(circle, ${color} 0%, rgba(255,255,255,0.35) 40%, rgba(255,255,255,0) 70%)`;
        spark.style.left = '50%'; spark.style.top = '50%'; spark.style.transform = 'translate(-50%,-50%)';
        targetImg.parentElement.appendChild(spark);
        targetImg.classList.add('damage-flash');
        setTimeout(() => { spark.remove(); targetImg.classList.remove('damage-flash'); }, 500);
    }

    // è¦–è¦ºç‰¹æ•ˆ & å„²å­˜
    function showFloatText(text, index) {
        const card = document.getElementById(`card-${index}`);
        if(card) { const floatEl = document.createElement('div'); floatEl.className = 'float-text'; floatEl.innerText = text; floatEl.style.left = '50%'; floatEl.style.top = '50%'; floatEl.style.transform = 'translate(-50%, -50%)'; card.appendChild(floatEl); setTimeout(() => floatEl.remove(), 1600); }
    }
    function showLevelUpEffect() { const overlay = document.getElementById('level-up-overlay'); overlay.style.display = 'flex'; setTimeout(() => overlay.style.display = 'none', 2000); }
    function saveData() { localStorage.setItem('wuxia_class_data', JSON.stringify(students)); showNotify("å®—é–€åå†Šå·²ä¿å­˜"); }
    function resetAll() { showCustomModal({ title: "è§£æ•£å®—é–€", msg: "ç¢ºå®šè¦ç‡’æ¯€åå†Šï¼Ÿæ‰€æœ‰è³‡æ–™å°‡æ¶ˆå¤±ã€‚", showCancel: true, onConfirm: () => { localStorage.removeItem('wuxia_class_data'); students = []; renderGrid(); showNotify("ä¸€åˆ‡å›æ­¸è™›ç„¡..."); } }); }
    function showNotify(msg) { const bar = document.getElementById('notification-bar'); bar.innerText = msg; bar.style.opacity = '1'; setTimeout(() => bar.style.opacity = '0', 3000); }
</script>
</body>
</html>
